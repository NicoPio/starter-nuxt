openapi: 3.0.3
info:
  title: Password Reset API
  description: API pour la réinitialisation de mot de passe avec tokens sécurisés
  version: 1.0.0
  contact:
    name: API Support
    email: support@votre-domaine.com

servers:
  - url: http://localhost:3000/api
    description: Serveur de développement local
  - url: https://votre-domaine.com/api
    description: Serveur de production

tags:
  - name: Password Reset
    description: Opérations de réinitialisation de mot de passe

paths:
  /auth/forgot-password:
    post:
      tags:
        - Password Reset
      summary: Demander un lien de réinitialisation
      description: |
        Génère un token de réinitialisation et envoie un email avec un lien sécurisé.

        **Comportement de sécurité** :
        - Retourne toujours "success" même si l'email n'existe pas (protection anti-énumération)
        - Invalide tous les anciens tokens de l'utilisateur
        - Rate limiting : 1 demande par 5 minutes par email
        - Token valide pendant 1 heure

      operationId: requestPasswordReset
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  description: Adresse email de l'utilisateur
                  example: [email protected]
            examples:
              validRequest:
                summary: Demande valide
                value:
                  email: [email protected]

      responses:
        '200':
          description: Demande traitée avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              examples:
                success:
                  summary: Réponse standard
                  value:
                    success: true
                    message: "Si cet email existe, un lien de réinitialisation a été envoyé."

        '400':
          description: Email invalide (format incorrect)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidEmail:
                  summary: Format d'email invalide
                  value:
                    statusCode: 400
                    statusMessage: "Invalid email format"
                    message: "L'adresse email fournie n'est pas valide"

        '429':
          description: Trop de demandes (rate limit)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                rateLimited:
                  summary: Rate limit atteint
                  value:
                    statusCode: 429
                    statusMessage: "Too many requests"
                    message: "Veuillez attendre avant de demander un nouveau lien"
                    retryAfter: 300

        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/verify-reset-token:
    post:
      tags:
        - Password Reset
      summary: Vérifier la validité d'un token
      description: |
        Vérifie si un token de réinitialisation est valide sans le consommer.

        **Cas d'invalidité** :
        - Token inexistant
        - Token expiré (> 1 heure)
        - Token déjà utilisé
        - Token mal formé

      operationId: verifyResetToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
              properties:
                token:
                  type: string
                  description: Token de réinitialisation (43 caractères Base64URL)
                  example: "K7gNU3sdo-OL0wNhqoVWhr3g6s1xYv72ol_pe_Unols"
            examples:
              validToken:
                summary: Token valide
                value:
                  token: "K7gNU3sdo-OL0wNhqoVWhr3g6s1xYv72ol_pe_Unols"

      responses:
        '200':
          description: Token valide
          content:
            application/json:
              schema:
                type: object
                properties:
                  isValid:
                    type: boolean
                    example: true
                  expiresAt:
                    type: string
                    format: date-time
                    description: Date d'expiration du token
                    example: "2025-12-12T15:30:00.000Z"
              examples:
                validToken:
                  summary: Token valide
                  value:
                    isValid: true
                    expiresAt: "2025-12-12T15:30:00.000Z"

        '400':
          description: Token invalide
          content:
            application/json:
              schema:
                type: object
                properties:
                  isValid:
                    type: boolean
                    example: false
                  reason:
                    type: string
                    enum:
                      - TOKEN_NOT_FOUND
                      - TOKEN_EXPIRED
                      - TOKEN_USED
                      - TOKEN_INVALID
                    example: TOKEN_EXPIRED
                  message:
                    type: string
                    example: "Ce lien a expiré"
              examples:
                expired:
                  summary: Token expiré
                  value:
                    isValid: false
                    reason: TOKEN_EXPIRED
                    message: "Ce lien a expiré"
                used:
                  summary: Token déjà utilisé
                  value:
                    isValid: false
                    reason: TOKEN_USED
                    message: "Ce lien a déjà été utilisé"

  /auth/reset-password:
    post:
      tags:
        - Password Reset
      summary: Réinitialiser le mot de passe
      description: |
        Utilise un token valide pour définir un nouveau mot de passe.

        **Effets secondaires** :
        - Marque le token comme utilisé
        - Hash le nouveau mot de passe avec scrypt
        - Invalide toutes les sessions actives de l'utilisateur
        - Invalide tous les autres tokens de réinitialisation

      operationId: resetPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
                - password
                - confirmPassword
              properties:
                token:
                  type: string
                  description: Token de réinitialisation valide
                  example: "K7gNU3sdo-OL0wNhqoVWhr3g6s1xYv72ol_pe_Unols"
                password:
                  type: string
                  format: password
                  minLength: 8
                  description: Nouveau mot de passe (minimum 8 caractères)
                  example: "MonNouveauMotDePasse123!"
                confirmPassword:
                  type: string
                  format: password
                  description: Confirmation du mot de passe (doit être identique)
                  example: "MonNouveauMotDePasse123!"
            examples:
              validRequest:
                summary: Demande valide
                value:
                  token: "K7gNU3sdo-OL0wNhqoVWhr3g6s1xYv72ol_pe_Unols"
                  password: "MonNouveauMotDePasse123!"
                  confirmPassword: "MonNouveauMotDePasse123!"

      responses:
        '200':
          description: Mot de passe réinitialisé avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Mot de passe réinitialisé avec succès"
              examples:
                success:
                  summary: Réinitialisation réussie
                  value:
                    success: true
                    message: "Mot de passe réinitialisé avec succès"

        '400':
          description: Requête invalide
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                passwordMismatch:
                  summary: Mots de passe ne correspondent pas
                  value:
                    statusCode: 400
                    statusMessage: "Password mismatch"
                    message: "Les mots de passe ne correspondent pas"
                passwordTooShort:
                  summary: Mot de passe trop court
                  value:
                    statusCode: 400
                    statusMessage: "Password too short"
                    message: "Le mot de passe doit contenir au moins 8 caractères"
                invalidToken:
                  summary: Token invalide
                  value:
                    statusCode: 400
                    statusMessage: "Invalid token"
                    message: "Ce lien est invalide ou a expiré"
                    reason: "TOKEN_EXPIRED"

        '500':
          description: Erreur serveur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Opération réussie"

    ErrorResponse:
      type: object
      properties:
        statusCode:
          type: integer
          example: 400
        statusMessage:
          type: string
          example: "Bad Request"
        message:
          type: string
          example: "Une erreur est survenue"
        reason:
          type: string
          description: Code d'erreur machine-readable (optionnel)
          example: "TOKEN_EXPIRED"
        retryAfter:
          type: integer
          description: Secondes avant de pouvoir réessayer (pour 429 uniquement)
          example: 300

  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: nuxt-session
      description: Session cookie (non requis pour ces endpoints)

security: []  # Aucune authentification requise pour les endpoints de reset

externalDocs:
  description: Documentation complète du projet
  url: https://github.com/votre-org/votre-repo
